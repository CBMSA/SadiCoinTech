<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PhotoChat – Web3 Finance & Mini-Shop App</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body { background: #05070d; color: #e5e7eb; font-family: system-ui; }
.app { max-width: 420px; margin: auto; height: 100vh; display: flex; flex-direction: column; border: 1px solid #111827; border-radius: 12px; overflow: hidden; }
.header { background: #0b0f1a; padding: 12px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #111827; }
.logo { font-weight: 700; color: #22c55e; }
.chat-feed { flex: 1; overflow-y: auto; background: #111827; padding: 10px; display: flex; flex-direction: column; }
.msg { background: #1f2937; padding: 10px 14px; border-radius: 20px; margin: 6px 0; max-width: 70%; }
.msg.me { background: #22c55e; color: #000; margin-left: auto; }
.input-bar { display: flex; gap: 8px; padding: 10px; border-top: 1px solid #111827; background: #0b0f1a; }
.input-bar input { flex: 1; border-radius: 20px; padding: 10px; border: none; background: #1f2937; color: #e5e7eb; }
.input-bar button { border-radius: 20px; }
.virtual-card { background: linear-gradient(135deg,#111827,#020617); border-radius: 18px; padding: 16px; margin: 10px; color: #fff; text-align: center; }
.video-box { background: #000; border-radius: 12px; height: 200px; display: flex; align-items: center; justify-content: center; margin: 10px; }
.navbar-app { display: flex; gap: 6px; padding: 8px; background: #0b0f1a; }
.navbar-app button { flex: 1; background: #111827; border: none; color: #9ca3af; padding: 8px; border-radius: 10px; }
.navbar-app button.active { background: #22c55e; color: #000; }
.auth-box { padding: 20px; background: #111827; }
.shop-card { background: #1f2937; padding: 10px; border-radius: 14px; margin: 8px 0; display: flex; justify-content: space-between; align-items: center; }
</style>
</head>

<body>
<div class="app">

<div class="header">
<div class="logo">PhotoChat</div>
<div id="userLabel">Guest</div>
</div>

<!-- AUTH -->
<div id="authSection" class="auth-box">
<input id="email" class="form-control mb-2" placeholder="Email">
<input id="password" type="password" class="form-control mb-2" placeholder="Password">
<button class="btn btn-success w-100 mb-2" onclick="login()">Login</button>
<button class="btn btn-outline-light w-100" onclick="register()">Register</button>
<p id="authMsg" class="mt-2"></p>
</div>

<!-- APP CONTENT -->
<div id="appContent" style="display:none; flex:1; flex-direction:column">

<div class="virtual-card" id="virtualCard">
<div>Virtual Card</div>
<h4 id="cardNumber">0000 •••• •••• ••••</h4>
<small id="cardName">Unregistered User</small>
</div>

<div class="chat-feed" id="chatFeed"></div>

<div id="miniShop">
<h5 class="text-light ms-2">Mini Shop</h5>
<div id="shopItems"></div>
</div>

<div class="input-bar">
<input id="msgInput" placeholder="Type a message or amount">
<button class="btn btn-success" onclick="sendMessage()">Send</button>
</div>

<div class="navbar-app">
<button onclick="showTab('chat')" class="active">Chat</button>
<button onclick="showTab('history')">History</button>
<button onclick="showTab('fx')">FX</button>
<button onclick="showTab('video')">Call</button>
<button onclick="showTab('shop')">Shop</button>
<button onclick="showTab('kyc')">KYC</button>
</div>

</div>
</div>

<script>
const sb = supabase.createClient("YOUR_SUPABASE_URL","YOUR_SUPABASE_KEY");
let currentUser = null;

async function login(){
  const {error} = await sb.auth.signInWithPassword({email:email.value,password:password.value});
  if(error) return authMsg.innerText = error.message;
  initApp();
}

async function register(){
  const {error} = await sb.auth.signUp({email:email.value,password:password.value});
  if(error) return authMsg.innerText = error.message;
  authMsg.innerText = "Registration successful. You can login.";
}

async function logout(){
  await sb.auth.signOut();
  location.reload();
}

async function initApp(){
  const {data:{user}} = await sb.auth.getUser();
  if(!user) return;
  currentUser = user;
  userLabel.innerText = user.email;
  authSection.style.display="none";
  appContent.style.display="flex";
  await loadCard();
  loadShop();
  subscribeMessages();
}

async function loadCard(){
  const {data} = await sb.from("cards").select("*").eq("user_id",currentUser.id).single();
  if(data){
    cardNumber.innerText = "1234 •••• •••• " + data.last4;
    cardName.innerText = data.name;
  }
}

async function sendMessage(){
  if(!currentUser) return;
  const text = msgInput.value.trim();
  if(!text) return;
  const amount = Number(text);
  if(!isNaN(amount) && amount>0){
    await sb.from("transactions").insert({sender:currentUser.id,amount});
  }else{
    await sb.from("messages").insert({user_id:currentUser.id,content:text});
  }
  msgInput.value="";
}

function subscribeMessages(){
  sb.channel("msgs")
  .on("postgres_changes",{event:"INSERT",schema:"public",table:"messages"},payload=>{
    const m = payload.new;
    const div = document.createElement("div");
    div.className = "msg" + (m.user_id === currentUser.id ? " me" : "");
    div.innerText = m.content;
    chatFeed.appendChild(div);
    chatFeed.scrollTop = chatFeed.scrollHeight;
  })
  .subscribe();
}

async function loadShop(){
  const {data} = await sb.from("shop_items").select("*");
  shopItems.innerHTML = data?.map(item=>`<div class='shop-card'><span>${item.name}</span><span>$${item.price}</span></div>`).join('') || '<p class="text-light ms-2">No items available</p>';
}

function loadHistory(){ /* Transaction history as chat bubbles */ }
function loadFX(){ /* FX Rates UI */ }
function loadVideo(){ /* Video call UI */ }
function loadKYC(){ /* KYC upload UI */ }

function showTab(tab){
  document.querySelectorAll(".navbar-app button").forEach(b=>b.classList.remove("active"));
  event.target.classList.add("active");
  chatFeed.innerHTML='';
  if(tab==='chat') chatFeed.style.display='flex';
  if(tab==='history') loadHistory();
  if(tab==='fx') loadFX();
  if(tab==='video') loadVideo();
  if(tab==='shop') loadShop();
  if(tab==='kyc') loadKYC();
}

initApp();
</script>

</body>
</html>
