<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PhotoChat – Web3 Finance Super-App</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{background:#05070d;color:#e5e7eb;font-family:system-ui}
.app{max-width:420px;margin:auto;height:100vh;display:flex;flex-direction:column}
.header{background:#0b0f1a;padding:12px;border-bottom:1px solid #111827;display:flex;justify-content:space-between;align-items:center}
.logo{font-weight:700;color:#22c55e}
.balance-card{background:linear-gradient(135deg,#22c55e22,#3b82f622);border-radius:16px;padding:14px;margin:10px;text-align:center}
.feed{flex:1;overflow-y:auto;padding:10px}
.msg{background:#111827;padding:8px 12px;border-radius:12px;margin:6px 0;max-width:80%}
.me{background:#22c55e;color:#000;margin-left:auto}
.input-bar{display:flex;gap:8px;padding:10px;border-top:1px solid #111827}
.navbar-app{display:flex;gap:6px;padding:8px}
.navbar-app button{flex:1;background:#0b0f1a;border:none;color:#9ca3af;padding:8px;border-radius:10px}
.navbar-app button.active{background:#22c55e;color:#000}
.card-ui{background:#0b0f1a;border-radius:14px;padding:12px;margin:10px}
.virtual-card{background:linear-gradient(135deg,#111827,#020617);border-radius:18px;padding:16px;margin:10px;color:#fff}
.video-box{background:#000;border-radius:12px;height:200px;display:flex;align-items:center;justify-content:center;margin:10px}
</style>
</head>

<body>
<div class="app">

<div class="header">
<div class="logo">PhotoChat</div>
<div id="userLabel">Guest</div>
</div>

<!-- Virtual Card Display -->
<div class="virtual-card" id="virtualCard">
<div>Virtual Card</div>
<h4 id="cardNumber">0000 •••• •••• ••••</h4>
<small id="cardName">Unregistered User</small>
</div>

<div class="balance-card">
<div id="balance">Balance: $0.00</div>
<small>Web3 Multi-Currency Wallet</small>
</div>

<div id="feed" class="feed"></div>

<div class="input-bar">
<input id="msgInput" class="form-control" placeholder="Message or send amount">
<button class="btn btn-success" onclick="sendMessage()">Send</button>
</div>

<div class="navbar-app">
<button onclick="showTab('chat')" class="active">Chat</button>
<button onclick="showTab('fx')">FX</button>
<button onclick="showTab('video')">Call</button>
<button onclick="showTab('kyc')">KYC</button>
</div>

</div>

<script>
const sb = supabase.createClient("YOUR_SUPABASE_URL","YOUR_SUPABASE_KEY");
let currentUser=null;

async function loadUser(){
  const {data:{user}} = await sb.auth.getUser();
  if(!user) return;

  currentUser=user;
  userLabel.innerText=user.email;

  const {data}=await sb.from("wallets").select("*").eq("user_id",user.id).single();
  if(data) balance.innerText="Balance: $"+Number(data.balance).toFixed(2);

  loadCard();
  subscribeMessages();
}

async function loadCard(){
  if(!currentUser) return;

  const {data}=await sb.from("cards").select("*").eq("user_id",currentUser.id).single();

  if(data){
    cardNumber.innerText = "1234 •••• •••• " + data.last4;
    cardName.innerText = data.name;
  }
}

async function sendMessage(){
  if(!currentUser) return alert("Login required");

  const text=msgInput.value.trim();
  if(!text) return;

  const amount=Number(text);

  if(!isNaN(amount) && amount>0){
    await sb.from("transactions").insert({sender:currentUser.id,amount});
    alert("Sent $"+amount);
  }else{
    await sb.from("messages").insert({user_id:currentUser.id,content:text});
  }

  msgInput.value="";
}

function subscribeMessages(){
  sb.channel("msgs")
  .on("postgres_changes",{event:"INSERT",schema:"public",table:"messages"},payload=>{
    const m=payload.new;
    const div=document.createElement("div");
    div.className="msg"+(m.user_id===currentUser.id?" me":"");
    div.innerText=m.content;
    feed.appendChild(div);
  })
  .subscribe();
}

function loadFX(){
  feed.innerHTML=`
    <div class="card-ui">
      <h5>Live FX (via Vercel API)</h5>
      <button class="btn btn-success w-100" onclick="fetchFX()">Load Rates</button>
      <pre id="fxData"></pre>
    </div>`;
}

async function fetchFX(){
  const res = await fetch("/api/fx");
  const data = await res.json();
  fxData.innerText = JSON.stringify(data,null,2);
}

function loadVideo(){
  feed.innerHTML=`
    <div class="card-ui">
      <h5>Live Video Call</h5>
      <div class="video-box" id="videoBox">Camera Off</div>
      <button class="btn btn-success w-100" onclick="startCall()">Start Camera</button>
    </div>`;
}

async function startCall(){
  const stream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  videoBox.innerHTML = "";
  const video = document.createElement("video");
  video.srcObject = stream;
  video.autoplay = true;
  video.playsInline = true;
  video.style.width = "100%";
  videoBox.appendChild(video);
}

function loadKYC(){
  feed.innerHTML=`
    <div class="card-ui">
      <h5>Identity Verification</h5>
      <input type="file" id="idFile" class="form-control mb-2">
      <button class="btn btn-success w-100" onclick="uploadID()">Submit</button>
      <p id="kycMsg"></p>
    </div>`;
}

async function uploadID(){
  if(!currentUser) return;

  const file=idFile.files[0];
  if(!file) return kycMsg.innerText="Select file";

  const {error}=await sb.storage.from("kyc").upload(`${currentUser.id}/${file.name}`,file);

  if(!error){
    await sb.from("kyc").insert({user_id:currentUser.id,status:"pending"});
    kycMsg.innerText="Submitted for review";
  }else{
    kycMsg.innerText=error.message;
  }
}

function showTab(tab){
  document.querySelectorAll(".navbar-app button").forEach(b=>b.classList.remove("active"));
  event.target.classList.add("active");

  if(tab==='chat') feed.innerHTML='';
  if(tab==='fx') loadFX();
  if(tab==='video') loadVideo();
  if(tab==='kyc') loadKYC();
}

loadUser();
</script>

</body>
</html>
