<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PhotoChat – Production Web3 Marketplace & SDC Super App</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body { background:#05070d; color:#e5e7eb; font-family:system-ui; }
.app { max-width:420px; margin:auto; height:100vh; display:flex; flex-direction:column; border:1px solid #111827; border-radius:12px; overflow:hidden; }
.header { background:#0b0f1a; padding:12px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #111827; }
.logo { font-weight:700; color:#22c55e; }
.chat-feed { flex:1; overflow-y:auto; background:#111827; padding:10px; display:flex; flex-direction:column; }
.msg { background:#1f2937; padding:10px 14px; border-radius:20px; margin:6px 0; max-width:70%; }
.msg.me { background:#22c55e; color:#000; margin-left:auto; }
.input-bar { display:flex; gap:8px; padding:10px; border-top:1px solid #111827; background:#0b0f1a; }
.input-bar input { flex:1; border-radius:20px; padding:10px; border:none; background:#1f2937; color:#e5e7eb; }
.virtual-card { background:linear-gradient(135deg,#111827,#020617); border-radius:18px; padding:16px; margin:10px; text-align:center; }
.navbar-app { display:flex; gap:6px; padding:8px; background:#0b0f1a; }
.navbar-app button { flex:1; background:#111827; border:none; color:#9ca3af; padding:8px; border-radius:10px; }
.navbar-app button.active { background:#22c55e; color:#000; }
.auth-box { padding:20px; background:#111827; }
.shop-card { background:#1f2937; padding:10px; border-radius:14px; margin:8px 0; }
.loading { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:#020617; color:#22c55e; font-size:20px; z-index:999; }
</style>
</head>

<body>

<div id="loadingScreen" class="loading">SadiCoinTech Loading...</div>

<div id="app" style="display:none">
<div class="app">

<div class="header">
<div class="logo">PhotoChat</div>
<div id="userLabel">Guest</div>
</div>

<!-- PHONE OTP AUTH -->
<div id="authSection" class="auth-box">
<input id="phone" class="form-control mb-2" placeholder="Phone Number (+263...)" />
<button class="btn btn-success w-100 mb-2" onclick="sendOTP()">Send OTP</button>
<input id="otp" class="form-control mb-2" placeholder="Enter OTP" />
<button class="btn btn-outline-light w-100" onclick="verifyOTP()">Verify OTP</button>
<p id="authMsg"></p>
</div>

<!-- APP -->
<div id="appContent" style="display:none; flex:1; flex-direction:column">

<div class="virtual-card">
<div>SDC Virtual Card</div>
<h4 id="cardNumber">0000 •••• •••• ••••</h4>
<small id="cardName">Unregistered</small>
</div>

<div class="chat-feed" id="chatFeed"></div>

<!-- MARKETPLACE -->
<div id="miniShop">
<h6 class="ms-2">Marketplace</h6>
<input id="itemTitle" class="form-control mb-1" placeholder="Item title">
<input id="itemPrice" type="number" class="form-control mb-1" placeholder="Price">
<select id="currency" class="form-control mb-1">
<option value="SDC">SDC</option>
<option value="USD">USD</option>
<option value="ZAR">ZAR</option>
</select>
<button class="btn btn-success w-100 mb-2" onclick="uploadItem()">Upload Item</button>
<div id="shopItems"></div>
</div>

<div class="input-bar">
<input id="msgInput" placeholder="Type amount to send">
<button class="btn btn-success" onclick="sendMoney()">Send</button>
</div>

<div class="navbar-app">
<button onclick="showTab('chat')" class="active">Chat</button>
<button onclick="showTab('history')">History</button>
<button onclick="showTab('shop')">Shop</button>
<button onclick="showTab('invoice')">Invoice</button>
</div>

</div>
</div>
</div>

<script>
const sb = supabase.createClient("YOUR_SUPABASE_URL","YOUR_SUPABASE_KEY");
let currentUser=null;
let lastTransaction=null;
const FEE_PERCENT=2;

window.addEventListener("load",()=>{
  loadingScreen.style.display="none";
  app.style.display="block";
});

async function sendOTP(){
  const {error}=await sb.auth.signInWithOtp({phone:phone.value});
  authMsg.innerText=error?error.message:"OTP sent";
}

async function verifyOTP(){
  const {data,error}=await sb.auth.verifyOtp({phone:phone.value,token:otp.value,type:'sms'});
  if(error) return authMsg.innerText=error.message;
  currentUser=data.user;
  userLabel.innerText=currentUser.phone;
  authSection.style.display="none";
  appContent.style.display="flex";
  loadShop();
}

// DOUBLE-ENTRY LEDGER TRANSACTION
async function sendMoney(){
  const amount=Number(msgInput.value);
  if(!amount) return;

  const fee=amount*FEE_PERCENT/100;
  const total=amount+fee;

  const {data,error}=await sb.rpc("create_transaction",{
    p_user:currentUser.id,
    p_amount:amount,
    p_fee:fee,
    p_total:total
  });

  if(error) return alert(error.message);

  lastTransaction=data;
  alert("Transaction approved");
}

async function uploadItem(){
  await sb.from("shop_items").insert({title:itemTitle.value,price:itemPrice.value,currency:currency.value});
  loadShop();
}

async function loadShop(){
  const {data}=await sb.from("shop_items").select("*");
  shopItems.innerHTML=data?.map(i=>`<div class='shop-card'><b>${i.title}</b><br>${i.price} ${i.currency}</div>`).join('');
}

function showTab(tab){
  if(tab==='invoice') downloadInvoice();
}

function downloadInvoice(){
  if(!lastTransaction) return alert("No transaction");

  const text=`PHOTOCHAT RECEIPT\n\nTransaction ID: ${lastTransaction.id}\nAmount: ${lastTransaction.amount}\nFee: ${lastTransaction.fee}\nTotal: ${lastTransaction.total}\nStatus: approved\nDate: ${new Date().toLocaleString()}\n© SadiCoinTech ${new Date().getFullYear()}`;

  const blob=new Blob([text],{type:"text/plain"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="receipt.txt";
  a.click();
}
</script>

</body>
</html>
